---
description: 問題分析與除錯流程
alwaysApply: true
---

# 問題分析流程（標準作業程序）

當遇到執行錯誤、Hook 失敗、或預期行為不符時，按以下順序進行分析：

## 步驟 1: 檢查 Frida 執行腳本輸出

### 必須檢查的項目
- [ ] 查看 console.log 輸出內容
- [ ] 檢查錯誤訊息（Error、Exception）
- [ ] 查看堆疊追蹤（Stack Trace）
- [ ] 確認 Hook 是否成功附加
- [ ] 記錄函數調用的參數值
- [ ] 記錄函數的返回值
- [ ] 檢查線程 ID 和調用時機

### 輸出分析重點
- 函數是否被調用？
- 參數類型是否正確？
- 返回值是否符合預期？
- 是否有異常或錯誤？

## 步驟 2: 回到 JEB 驗證靜態分析

### 驗證項目
- [ ] **類別名稱**：確認類別全名是否正確（包含包名）
- [ ] **函數名稱**：確認方法名是否正確（注意重載）
- [ ] **變數名稱**：確認變數名和類型是否正確
- [ ] **方法簽名**：確認參數類型和返回值類型
- [ ] **執行流程**：追蹤方法內的執行流程
- [ ] **分支邏輯**：檢查條件判斷和分支
- [ ] **調用關係**：查看方法的調用者和被調用者

### 常見問題
- 類別名稱拼寫錯誤
- 方法名混淆（Obfuscation）
- 參數類型不匹配
- 方法簽名錯誤（重載方法）

## 步驟 3: 回到 IDA 驗證 Native 層

### 驗證項目
- [ ] **函數位址**：確認函數地址是否正確
- [ ] **函數簽名**：檢查參數類型和數量
- [ ] **執行流程**：追蹤函數內的執行流程
- [ ] **分支邏輯**：檢查條件判斷和跳轉
- [ ] **交叉引用**：查看 XREF（調用者和被調用者）
- [ ] **符號名稱**：確認導出符號名稱
- [ ] **偏移量**：驗證相對偏移是否正確

### 常見問題
- 函數地址計算錯誤
- 符號名稱錯誤（導出函數名）
- 偏移量計算錯誤
- 參數傳遞方式錯誤（ARM/ARM64 calling convention）

## 步驟 4: 查詢 Obsidian 知識庫

### 使用 Obsidian MCP 搜尋
- [ ] 搜尋類似問題的關鍵字
- [ ] 查看歷史分析報告
- [ ] 檢查相關函數的分析記錄
- [ ] 參考已知的解決方案
- [ ] 查看注意事項和已知問題

### 搜尋策略
- 使用函數名、類別名作為關鍵字
- 搜尋錯誤訊息內容
- 查看相關主題的分析文檔
- 檢查是否有繞過方法記錄

---

# 問題解決後動作

## 1. 報告產生原則

### 報告產生規則（強制）
- **完整規則**：請參考 `40_reporting_style.mdc`
- **重點提醒**：
  - 只有用戶明確要求時才產生報告
  - 一般問題解決只需修正腳本，不需要報告
  - 所有報告必須保存到 `docs/` 資料夾

## 2. 測試腳本管理

### 測試腳本存放位置
```
frida-test/
  ├── test_{功能描述}.js
  ├── test_{另一個功能}.js
  └── README.md  # 測試腳本說明
```

### 測試腳本命名規範
- 格式：`test_{功能描述}.js`
- 範例：
  - `test_vtap_creation.js`
  - `test_token_provisioning.js`
  - `test_api_encryption.js`

### 測試腳本內容要求
```javascript
/**
 * 測試腳本：{功能描述}
 * 
 * 目的: {測試目的}
 * 目標: {目標函數/類別}
 * 日期: {日期}
 */

// 配置
const TARGET_CLASS = "com.example.TargetClass";
const ENABLE_VERBOSE = true;

// 測試邏輯
Java.perform(function() {
    // 測試代碼
});
```

## 3. 修正執行錯誤腳本

### 修正流程
1. **定位問題**：根據分析流程找出問題根源
2. **修正代碼**：直接修正有問題的 Frida 腳本
3. **添加註釋**：說明修正原因和修正內容
4. **驗證修正**：確認修正後的腳本正常運作
5. **更新文檔**：如需要，更新相關使用說明

### 修正註釋格式
```javascript
// [FIX] 修正原因：{說明}
// 原問題：{問題描述}
// 修正方法：{修正方法}
// 日期：{日期}
```

### 驗證檢查清單
- [ ] 腳本可以正常執行
- [ ] Hook 成功附加
- [ ] 參數和返回值正確
- [ ] 沒有錯誤或異常
- [ ] 功能符合預期

---

# 問題分析檢查清單

## 開始分析前
- [ ] 確認問題現象清楚
- [ ] 收集相關錯誤訊息
- [ ] 準備必要的工具（JEB、IDA、Obsidian）

## 分析過程中
- [ ] 按順序執行四個步驟
- [ ] 記錄每個步驟的發現
- [ ] 驗證每個假設
- [ ] 記錄驗證結果

## 分析完成後
- [ ] 確認問題根源
- [ ] 決定是否需要報告
- [ ] 產生測試腳本（如需要）
- [ ] 修正錯誤腳本
- [ ] 驗證修正結果

---

# GitHub Issue 分析與實現規範

當需要分析 GitHub Issue 並創建實現規範時，使用以下流程和模板。

## Issue 分析流程

1. **獲取 Issue 詳情**
   - 使用 `gh issue view <issue_number>` 獲取 Issue 詳細信息
   - 記錄 Issue 標題、描述、標籤、狀態等

2. **審查相關代碼和項目結構**
   - 查看相關的文件和目錄結構
   - 了解現有的實現方式
   - 檢查相關的分析報告和文檔

3. **深入分析需求**
   - 理解問題的核心
   - 識別技術挑戰
   - 確定實現範圍

4. **創建詳細技術規範**
   - 使用下方模板創建完整規範
   - 確保所有章節都填寫完整

5. **遵循開發原則**
   - 嚴格遵循 TDD（測試驅動開發）原則
   - 採用 KISS（保持簡單）方法
   - 強制執行 300 行文件限制（如適用）

6. **輸出完整技術規範**
   - 生成完整的技術規範供審查
   - 保存到 `docs/` 資料夾（如需要）

---

## 實現規範模板

### 1. Issue 摘要
簡要概述 Issue 的內容和背景

### 2. 問題陳述
清楚定義需要解決的問題

### 3. 技術方法
高層次的解決方案和架構決策

### 4. 實現計劃
逐步分解的實現任務

### 5. 測試計劃
測試策略和需要編寫的測試用例

### 6. 需要修改的文件
列出需要更改的現有文件

### 7. 需要創建的文件
列出需要創建的新文件

### 8. 可重用的現有工具
項目中可以重用的工具/輔助函數

### 9. 成功標準
可衡量的完成標準

### 10. 範圍外項目
本次實現不會處理的內容

---

## 逆向工程項目特定考量

### 分析重點
- **版本兼容性**：確認適用的 App 版本（從 `config/VERSION_INFO.md` 獲取）
- **工具兼容性**：確認 Frida、IDA、JEB 版本
- **現有腳本**：檢查 `frida-script/` 中是否有相關腳本
- **現有分析**：查看 `docs/` 中是否有相關分析報告

### 實現注意事項
- **測試腳本**：新功能應在 `frida-test/` 中創建測試腳本
- **文檔更新**：如需要，更新相關分析文檔
- **版本標註**：所有實現必須標註適用的 App 版本

### 報告產生
- **完整規則**：請參考 `40_reporting_style.mdc`

---

## 使用範例

當用戶要求分析 Issue 時：

1. 獲取 Issue 詳情
2. 分析問題和需求
3. 創建完整的實現規範（使用上述模板）
4. 如用戶要求，生成報告並保存到 `docs/` 資料夾
