---
description: 銀行 App 高風控環境的證據收集與判斷樹（偏觀測與歸因）
alwaysApply: false
---

# 高風控 App 觀測重點
- 本規則專門針對銀行/金融類 App 的高風控機制進行觀測與分析
- 重點關注：完整性檢測、環境檢測、注入檢測、TEE/Keymaster 使用

# 證據收集層級

## 1. 進程與記憶體觀測
- `/proc/maps`：檢查載入的模組、權限、路徑
- `/proc/self/maps`：當前進程記憶體映射
- ELF phdr：檢查程式標頭、段資訊
- 關鍵觀測點：
  - 異常模組載入（Frida、Xposed、Magisk）
  - 記憶體權限異常（可執行堆疊）
  - 動態庫注入痕跡

## 2. 系統調用追蹤
- 關鍵 syscall 觀測：
  - `ptrace`：反調試檢測
  - `openat`/`open`：文件訪問模式
  - `read`/`write`：敏感文件讀寫
  - `execve`：進程執行
  - `clone`/`fork`：進程創建
- 使用 strace 或 Frida 的 Interceptor 追蹤

## 3. Binder 通訊分析
- 追蹤 Binder 交易：
  - 服務名稱（Service Name）
  - 交易代碼（Transaction Code）
  - 參數與返回值
- 關鍵服務：
  - `android.security.keystore`：Keymaster 服務
  - `android.os.ServiceManager`：系統服務
  - 自定義安全服務

## 4. TEE/Keymaster 使用
- 觀測 Keymaster HAL 調用
- 檢查 KeyStore 操作：
  - 密鑰生成
  - 密鑰導入
  - 簽名/驗證操作
- 記錄操作參數（不包含敏感數據）

## 5. 完整性檢測點
- 檢測觸發時機：
  - App 啟動時
  - 關鍵操作前（登入、交易）
  - 定期檢查
- 檢測內容：
  - APK 簽名驗證
  - DEX 完整性
  - Native 庫完整性
  - 安裝來源驗證

# 判斷樹（決策流程）

```
檢測觸發
  ├─ 完整性檢測？
  │   ├─ APK 簽名 → 記錄簽名算法、證書
  │   ├─ DEX 驗證 → 記錄驗證方法、hash
  │   └─ Native 庫 → 記錄庫名、hash、載入路徑
  │
  ├─ 環境檢測？
  │   ├─ Root 檢測 → 記錄檢測方法、結果
  │   ├─ 開發者模式 → 記錄檢測點
  │   ├─ 模擬器檢測 → 記錄檢測指標
  │   └─ Hook 檢測 → 記錄檢測方法（maps/ptrace/等）
  │
  └─ 注入檢測？
      ├─ Frida 檢測 → 記錄檢測點、觸發條件
      ├─ Xposed 檢測 → 記錄檢測方法
      └─ 通用 Hook 檢測 → 記錄檢測機制
```

# 證據記錄格式

## 觀測記錄表

| 觀測點 | 條件 | 預期行為 | 實際行為 | 結論 |
|--------|------|----------|----------|------|
| `/proc/maps` 掃描 | App 啟動 | 無異常模組 | 發現 Frida 模組 | 觸發注入檢測 |
| Keymaster 調用 | 登入流程 | 正常簽名 | 返回錯誤 | TEE 驗證失敗 |

## 日誌標記

- 使用統一的 log tag 前綴：`[DBS_TRIAGE]`
- 格式：`[DBS_TRIAGE] [類別] [級別] 訊息`
- 類別：MAPS、SYSCALL、BINDER、KEYMASTER、INTEGRITY
- 級別：INFO、WARN、ERROR、DEBUG

# 風險評估框架

## 低風險（可觀測）
- 完整性檢測機制
- 環境檢測邏輯
- 日誌記錄與分析

## 中風險（需謹慎）
- 檢測繞過方法研究
- 測試環境驗證
- 防禦機制分析

## 高風險（禁止）
- 生產環境繞過
- 未授權訪問
- 憑證竊取
- 交易篡改

# 替代方案（防禦導向）

當遇到高風險需求時，提供以下替代方案：

1. **可觀測性增強**
   - 增加日誌記錄
   - 監控關鍵函數調用
   - 追蹤檢測觸發

2. **風險評估**
   - 分析檢測覆蓋面
   - 評估繞過難度
   - 識別潛在弱點

3. **除錯與硬化**
   - 修復檢測邏輯缺陷
   - 增強檢測機制
   - 改進錯誤處理

4. **測試與驗證**
   - 在受控環境測試
   - 驗證檢測有效性
   - 性能影響評估
